# 🔗 真实服务器连接配置指南

## 📋 前置准备

### 1. 安装依赖库

首先运行依赖安装脚本：

```bash
python install_dependencies.py
```

或手动安装：

```bash
pip install paramiko psutil cryptography
```

### 2. 确认服务器要求

目标服务器需要满足：
- ✅ SSH服务已启动（通常是22端口）
- ✅ 防火墙允许SSH连接
- ✅ 有效的用户账号和密码/密钥
- ✅ 用户有执行系统命令的权限

## 🔧 配置真实服务器

### 密码认证配置

```json
{
  "name": "生产服务器",
  "host": "192.168.1.100",
  "port": 22,
  "username": "admin",
  "auth_type": "password",
  "password": "your_password",
  "monitor_interval": 30,
  "description": "生产环境服务器",
  "enabled": true
}
```

### 密钥认证配置

```json
{
  "name": "安全服务器",
  "host": "server.example.com",
  "port": 22,
  "username": "ubuntu",
  "auth_type": "key",
  "private_key_path": "/home/user/.ssh/id_rsa",
  "key_password": "key_passphrase",
  "monitor_interval": 30,
  "description": "使用密钥认证的服务器",
  "enabled": true
}
```

## 🖥️ 界面配置步骤

### 1. 打开监控界面

访问：`http://localhost:8080/#/server-monitor/dashboard`

### 2. 添加服务器

1. 点击"配置服务器"按钮
2. 填写服务器信息：
   - **服务器名称**: 便于识别的名称
   - **主机地址**: 服务器IP或域名
   - **SSH端口**: 默认22
   - **认证方式**: 选择密码或密钥
   - **用户名**: SSH登录用户
   - **密码/密钥**: 根据认证方式填写

### 3. 测试连接

1. 在配置对话框中点击"测试连接"
2. 等待连接结果
3. 连接成功后保存配置

### 4. 查看监控数据

1. 在服务器下拉菜单中选择配置的服务器
2. 系统会自动获取真实监控数据
3. 查看CPU、内存、磁盘、网络等指标

## 📊 监控数据说明

### CPU监控
- **获取方式**: `top -bn1` 命令解析
- **指标**: 使用率百分比
- **更新频率**: 根据配置的监控间隔

### 内存监控
- **获取方式**: `free` 命令解析
- **指标**: 使用率、已用/总量（GB）
- **计算**: (已用内存/总内存) × 100%

### 磁盘监控
- **获取方式**: `df -h` 命令解析
- **指标**: 根分区使用率、剩余空间
- **单位**: 百分比和GB

### 网络监控
- **获取方式**: `/proc/net/dev` 文件解析
- **指标**: 发送/接收字节数
- **网卡**: 自动检测eth0/ens/enp等主网卡

## 🔍 测试验证

### 使用测试脚本

```bash
# 交互式测试
python test_server_monitor_api.py --interactive

# 完整测试
python test_server_monitor_api.py
```

### 测试步骤

1. **连接测试**
   ```bash
   # 选择选项3，输入服务器ID
   # 系统会测试SSH连接
   ```

2. **数据获取测试**
   ```bash
   # 选择选项4，获取监控数据
   # 查看是否返回真实数据
   ```

3. **实时数据测试**
   ```bash
   # 选择选项5，获取实时数据
   # 验证数据的实时性
   ```

## 🛠️ 故障排除

### 连接问题

#### SSH连接超时
```
错误: 连接超时，请检查主机地址和端口
解决:
1. ping 目标主机确认网络连通
2. telnet host 22 测试SSH端口
3. 检查防火墙设置
```

#### 认证失败
```
错误: SSH认证失败，请检查用户名和密码/密钥
解决:
1. 确认用户名和密码正确
2. 检查密钥文件路径和权限
3. 验证用户SSH登录权限
```

#### 权限不足
```
错误: 命令执行失败
解决:
1. 确认用户有执行系统命令权限
2. 检查sudo配置（如需要）
3. 使用有足够权限的用户
```

### 数据异常

#### 监控数据为空
```
可能原因:
1. 命令执行失败
2. 数据解析错误
3. 系统命令不兼容

解决方案:
1. 检查服务器日志
2. 手动执行监控命令测试
3. 确认系统兼容性
```

#### 数据不准确
```
可能原因:
1. 命令输出格式不同
2. 系统版本差异
3. 网络延迟

解决方案:
1. 调整监控间隔
2. 检查系统版本兼容性
3. 优化网络连接
```

## 🔒 安全建议

### 1. 认证方式
- **推荐**: 使用SSH密钥认证
- **避免**: 在配置中明文存储密码
- **建议**: 定期更换认证凭据

### 2. 用户权限
- **原则**: 最小权限原则
- **建议**: 创建专用监控用户
- **限制**: 只授予必要的系统查看权限

### 3. 网络安全
- **防火墙**: 限制SSH访问来源
- **端口**: 考虑使用非标准SSH端口
- **VPN**: 在不安全网络中使用VPN

### 4. 监控频率
- **平衡**: 监控精度与系统负载
- **建议**: 生产环境使用30秒-5分钟间隔
- **避免**: 过于频繁的监控请求

## 📈 性能优化

### 1. 连接池
- 系统会复用SSH连接
- 减少连接建立开销
- 提高监控效率

### 2. 数据缓存
- 短期缓存监控数据
- 避免重复请求
- 提升响应速度

### 3. 异步处理
- 后台获取监控数据
- 不阻塞用户界面
- 提升用户体验

## 🚀 扩展功能

### 1. 自定义监控命令
可以扩展监控脚本，添加自定义命令：

```python
# 在get_real_server_metrics方法中添加
stdin, stdout, stderr = ssh.exec_command("your_custom_command")
custom_data = stdout.read().decode().strip()
```

### 2. 告警功能
基于监控数据设置告警规则：

```python
if metrics['cpu'] > 80:
    send_alert("CPU使用率过高")
```

### 3. 历史数据存储
将监控数据存储到数据库：

```python
# 可集成InfluxDB、MySQL等
save_metrics_to_database(server_id, metrics)
```

## 📞 技术支持

遇到问题时：

1. **查看日志**: 检查Flask服务器控制台输出
2. **测试连接**: 使用SSH客户端手动测试
3. **验证命令**: 在目标服务器上手动执行监控命令
4. **检查权限**: 确认用户权限和系统兼容性

---

**🎯 现在你可以监控真实的服务器了！**
